<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Shadow Coach v1</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            height: 100vh;
            display: flex;
            flex-direction: column;
            background: #1a1a1a;
            color: #e0e0e0;
        }
        
        .header {
            padding: 1rem;
            background: #2a2a2a;
            border-bottom: 1px solid #3a3a3a;
            display: flex;
            gap: 1rem;
            align-items: center;
        }
        
        .status {
            font-size: 0.85rem;
            color: #888;
        }
        
        .status.active {
            color: #4caf50;
        }
        
        button {
            padding: 0.5rem 1rem;
            background: #4a4a4a;
            color: #fff;
            border: 1px solid #5a5a5a;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
        }
        
        button:hover {
            background: #5a5a5a;
        }
        
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }
        
        .pane {
            flex: 1;
            display: flex;
            flex-direction: column;
            border-right: 1px solid #3a3a3a;
            overflow: hidden;
        }
        
        .pane:last-child {
            border-right: none;
        }
        
        .pane-header {
            padding: 0.75rem 1rem;
            background: #2a2a2a;
            border-bottom: 1px solid #3a3a3a;
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        .transcript-content {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            line-height: 1.6;
        }
        
        .transcript-line {
            margin-bottom: 0.5rem;
            padding: 0.25rem 0;
            border-left: 3px solid transparent;
            padding-left: 0.5rem;
        }
        
        .transcript-line.stream-a {
            border-left-color: #4caf50;
        }
        
        .transcript-line.stream-b {
            border-left-color: #2196f3;
        }
        
        .transcript-timestamp {
            color: #888;
            font-size: 0.75rem;
            margin-right: 0.5rem;
        }
        
        .transcript-label {
            font-weight: 600;
            margin-right: 0.5rem;
        }
        
        .transcript-label.stream-a {
            color: #4caf50;
        }
        
        .transcript-label.stream-b {
            color: #2196f3;
        }
        
        .transcript-text {
            color: #e0e0e0;
        }
        
        .transcript-text.interim {
            opacity: 0.6;
            font-style: italic;
        }
        
        .chat-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        .chat-message {
            padding: 0.75rem 1rem;
            border-radius: 8px;
            max-width: 80%;
            word-wrap: break-word;
        }
        
        .chat-message.user {
            background: #4a4a4a;
            align-self: flex-end;
        }
        
        .chat-message.assistant {
            background: #2a4a2a;
            align-self: flex-start;
        }
        
        .chat-message.auto-reflection {
            background: #3a2a4a;
            border-left: 3px solid #9c27b0;
            align-self: flex-start;
        }
        
        .reflection-indicator {
            font-size: 0.8rem;
            color: #bb86fc;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 600;
        }
        
        .chat-input-area {
            padding: 1rem;
            border-top: 1px solid #3a3a3a;
            display: flex;
            gap: 0.5rem;
        }
        
        .chat-input {
            flex: 1;
            padding: 0.75rem;
            background: #2a2a2a;
            border: 1px solid #3a3a3a;
            border-radius: 4px;
            color: #e0e0e0;
            font-size: 0.9rem;
        }
        
        .chat-input:focus {
            outline: none;
            border-color: #4a4a4a;
        }
    </style>
</head>
<body>
    <div class="header">
        <button id="startBtn">Start Audio</button>
        <button id="stopBtn" disabled>Stop Audio</button>
        <div class="status" id="status">Stopped</div>
    </div>
    
    <div class="container">
        <div class="pane">
            <div class="pane-header">Live Transcript</div>
            <div class="transcript-content" id="transcriptContent">
                <div style="color: #888; padding: 1rem;">Waiting for audio to start...</div>
            </div>
        </div>
        
        <div class="pane">
            <div class="pane-header">Coach Chat</div>
            <div class="chat-content">
                <div class="chat-messages" id="chatMessages">
                    <div class="chat-message assistant">
                        <div>I'm your AI conversation coach. I can help you analyze and reflect on your conversations. Ask me anything about the transcript, and I'll provide insights and discussion. (I can also use the Socratic method if you ask!)</div>
                    </div>
                </div>
                <div class="chat-input-area">
                    <input type="text" class="chat-input" id="chatInput" placeholder="Ask a question..." />
                    <button id="sendBtn">Send</button>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        const API_BASE = '';
        
        let eventSource = null;
        let reflectionEventSource = null;
        let audioRunning = false;
        
        // Audio controls
        document.getElementById('startBtn').addEventListener('click', async () => {
            try {
                const response = await fetch(`${API_BASE}/audio/start`, { method: 'POST' });
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                const result = await response.json();
                if (result.status === 'started') {
                    audioRunning = true;
                    document.getElementById('startBtn').disabled = true;
                    document.getElementById('stopBtn').disabled = false;
                    document.getElementById('status').textContent = 'Running';
                    document.getElementById('status').classList.add('active');
                    startTranscriptStream();
                    startReflectionStream();
                } else {
                    alert('Failed to start: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error starting audio:', error);
                alert('Failed to start audio: ' + error.message);
            }
        });
        
        document.getElementById('stopBtn').addEventListener('click', async () => {
            try {
                await fetch(`${API_BASE}/audio/stop`, { method: 'POST' });
            } catch (error) {
                console.error('Error stopping audio:', error);
            }
            audioRunning = false;
            document.getElementById('startBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
            document.getElementById('status').textContent = 'Stopped';
            document.getElementById('status').classList.remove('active');
            if (eventSource) {
                eventSource.close();
                eventSource = null;
            }
            if (reflectionEventSource) {
                reflectionEventSource.close();
                reflectionEventSource = null;
            }
            document.getElementById('transcriptContent').innerHTML = '<div style="color: #888; padding: 1rem;">Audio stopped.</div>';
        });
        
        // Transcript streaming
        function startTranscriptStream() {
            if (eventSource) {
                eventSource.close();
            }
            
            eventSource = new EventSource(`${API_BASE}/transcript/stream`);
            const transcriptContent = document.getElementById('transcriptContent');
            
            // Clear initial message
            if (transcriptContent.children.length === 1 && transcriptContent.children[0].textContent.includes('Waiting')) {
                transcriptContent.innerHTML = '';
            }
            
            eventSource.onmessage = (event) => {
                // EventSource automatically strips 'data: ' prefix, so event.data is the JSON string
                // Handle both cases: with or without 'data: ' prefix (for robustness)
                let dataStr = event.data;
                if (dataStr.startsWith('data: ')) {
                    dataStr = dataStr.substring(6);
                }
                
                // Skip heartbeat messages
                if (dataStr.trim() === '' || dataStr === 'heartbeat') {
                    return;
                }
                
                try {
                    const data = JSON.parse(dataStr);
                    addTranscriptLine(data);
                } catch (e) {
                    console.error('Error parsing transcript event:', e, 'Data:', dataStr);
                }
            };
            
            eventSource.onerror = () => {
                if (audioRunning) {
                    // Reconnect after delay
                    setTimeout(startTranscriptStream, 2000);
                }
            };
        }
        
        function addTranscriptLine(data) {
            const transcriptContent = document.getElementById('transcriptContent');
            const line = document.createElement('div');
            line.className = `transcript-line stream-${data.stream.toLowerCase()}`;
            
            const timestamp = new Date(data.ts * 1000).toLocaleTimeString();
            const label = data.stream === 'A' ? 'MIC' : 'LOOP';
            
            line.innerHTML = `
                <span class="transcript-timestamp">${timestamp}</span>
                <span class="transcript-label stream-${data.stream.toLowerCase()}">[${label}]</span>
                <span class="transcript-text ${data.is_final ? '' : 'interim'}">${escapeHtml(data.text)}</span>
            `;
            
            transcriptContent.appendChild(line);
            transcriptContent.scrollTop = transcriptContent.scrollHeight;
        }
        
        // Reflection streaming
        function startReflectionStream() {
            if (reflectionEventSource) {
                reflectionEventSource.close();
            }
            
            reflectionEventSource = new EventSource(`${API_BASE}/coach/reflections/stream`);
            
            reflectionEventSource.onmessage = (event) => {
                // Handle both cases: with or without 'data: ' prefix
                let dataStr = event.data;
                if (dataStr.startsWith('data: ')) {
                    dataStr = dataStr.substring(6);
                }
                
                // Skip heartbeat messages
                if (dataStr.trim() === '' || dataStr === 'heartbeat') {
                    return;
                }
                
                try {
                    const data = JSON.parse(dataStr);
                    addReflectionMessage(data);
                } catch (e) {
                    console.error('Error parsing reflection event:', e, 'Data:', dataStr);
                }
            };
            
            reflectionEventSource.onerror = () => {
                if (audioRunning) {
                    // Reconnect after delay
                    setTimeout(startReflectionStream, 2000);
                }
            };
        }
        
        function addReflectionMessage(data) {
            const chatMessages = document.getElementById('chatMessages');
            const reflectionMsg = document.createElement('div');
            reflectionMsg.className = 'chat-message auto-reflection';
            
            const indicator = document.createElement('div');
            indicator.className = 'reflection-indicator';
            indicator.textContent = 'ðŸ’¡ Reflection Question';
            
            const content = document.createElement('div');
            content.innerHTML = escapeHtml(data.text).replace(/\n/g, '<br>');
            
            reflectionMsg.appendChild(indicator);
            reflectionMsg.appendChild(content);
            chatMessages.appendChild(reflectionMsg);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        // Chat
        const chatInput = document.getElementById('chatInput');
        const sendBtn = document.getElementById('sendBtn');
        const chatMessages = document.getElementById('chatMessages');
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        async function sendMessage() {
            const message = chatInput.value.trim();
            if (!message) return;
            
            // Add user message to UI
            const userMsg = document.createElement('div');
            userMsg.className = 'chat-message user';
            userMsg.textContent = message;
            chatMessages.appendChild(userMsg);
            chatInput.value = '';
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            // Send to backend
            try {
                const response = await fetch(`${API_BASE}/coach/chat`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                
                // Add assistant response
                const assistantMsg = document.createElement('div');
                assistantMsg.className = 'chat-message assistant';
                assistantMsg.innerHTML = escapeHtml(result.response).replace(/\n/g, '<br>');
                chatMessages.appendChild(assistantMsg);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            } catch (error) {
                console.error('Chat error:', error);
                const errorMsg = document.createElement('div');
                errorMsg.className = 'chat-message assistant';
                errorMsg.style.background = '#4a2a2a';
                errorMsg.textContent = 'Error: ' + error.message;
                chatMessages.appendChild(errorMsg);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
        }
        
        sendBtn.addEventListener('click', sendMessage);
        chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
        
        // Status polling
        setInterval(async () => {
            if (audioRunning) {
                try {
                    const response = await fetch(`${API_BASE}/audio/status`);
                    if (response.ok) {
                        const status = await response.json();
                        const micBytes = (status.mic?.bytes_received || 0).toLocaleString();
                        const loopBytes = (status.loopback?.bytes_received || 0).toLocaleString();
                        document.getElementById('status').textContent = 
                            `Running | Mic: ${micBytes} bytes | Loopback: ${loopBytes} bytes`;
                    }
                } catch (error) {
                    // Silently ignore status polling errors
                    console.debug('Status poll error:', error);
                }
            }
        }, 2000);
    </script>
</body>
</html>
